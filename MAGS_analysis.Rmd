---
title: "MAGS_analysis"
author: "ruben"
date: "22/04/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Librairies

```{r,message=F,warning=F}

library(dplyr)
library(readr)
library(pheatmap)
library(data.table)


source(file = "functions.R")

```

## DonnÃ©es

```{r,message=F,warning=F}

load("curated_v3_otu_tax.rda")

## MAGS annotations data
mags_tax_file = readr::read_tsv("MAGS_files/annotations_url_metadata_opendata.tsv") %>%
  filter(assigned_genus=="Bifidobacterium") %>%
  select(genome_name,study,sample_name,assigned_species,completeness, average_distance)

# MAGS linked to other ID's
mags_tax_gene_id_eggnog <- readr::read_csv2("MAGS_files/mags_tax_gene_id_eggnog.csv") %>%
   select(-X1)

```


## Prepare plot

```{r,message=F,warning=F}


mags_ko_table <- mags_tax_gene_id_eggnog %>%
   filter(completeness >= 90) %>%
   filter(KEGG_ko != "-") %>%
   group_by(KEGG_ko) %>%
  mutate(ko_n=n()) %>%
   filter(ko_n>10) %>%
   ungroup() %>%
   group_by(genome_name,KEGG_ko) %>%
   summarise(n=n()) %>%
   mutate(n=ifelse(n>1,2,n)) %>%
   reshape2::dcast(genome_name~KEGG_ko, value.var = "n", fill=0)

mags_cazy_table <- mags_tax_gene_id_eggnog %>%
   filter(completeness >= 90) %>%
   filter(CAZy != "-") %>%
   group_by(CAZy) %>%
  mutate(cazy_n=n()) %>%
   filter(cazy_n>10) %>%
   ungroup() %>%
   group_by(genome_name,CAZy) %>%
   summarise(n=n()) %>%
   mutate(n=ifelse(n>1,2,n)) %>%
   reshape2::dcast(genome_name~CAZy, value.var = "n", fill=0)

   

heat_ko <- mags_ko_table %>%
  tibble::column_to_rownames("genome_name") %>%
  as.matrix()

heat_cazy <- mags_cazy_table %>%
  tibble::column_to_rownames("genome_name") %>%
  as.matrix()

```

## filter heatmap/add metadata

```{r,message=F,warning=F}

sample <- sampleMetadata

## if one ppl has several samples, keep the sample with the highest nb of reads
sample <- unique(setDT(sampleMetadata)[order(subject_id, -number_reads)], by = "subject_id")

metadata <- sample %>%
   ## transform disease and westernized to good format
   transform_disease(.) %>%
   transform_westernized(.) %>%
   select(sample_id, body_site, disease, age_category, gender, country, westernized, BMI, antibiotics_current_use)


## merge with mags_tax

mags_tax <- mags_tax_file %>%
   merge(metadata, by.x = "sample_name", by.y = "sample_id") %>%
   tibble::column_to_rownames("genome_name") %>%
   filter(assigned_species != "N/A") %>%
   filter(grepl("adolescentis|animalis|longum|bifidum|dentium|pseudocatenulatum|catenulatum", assigned_species))

```

## Filter heat

```{r,message=F,warning=F}

## we filter heat lines which are in mags_tax rownames

heat_ko <- heat_ko %>%
   data.frame(.) %>%
   filter(row.names(.) %in% rownames(mags_tax))


heat_cazy <- heat_cazy %>%
   data.frame(.) %>%
   filter(row.names(.) %in% rownames(mags_tax))

# the species
species <- levels(factor(mags_tax$assigned_species))

```

## Delete the species not assigned to MAGS

```{r,message=F,warning=F, fig.height=9, fig.width = 9}

for (one_species in species){
   
   mags_tax_filtered <- mags_tax %>% filter(assigned_species == one_species)
   
   heat_ko_filtered <- heat_ko %>% filter(row.names(.) %in% rownames(mags_tax_filtered))
   
   
   if(nrow(heat_ko_filtered) <10){
      
      species <- species[!species %in% one_species]
      
      }
      
   }

mags_tax <- mags_tax %>% filter(assigned_species %in% species)

```

## Plotting cazy enzymes

```{r,message=F,warning=F, fig.height=9, fig.width = 9}

library("remotes")
library("RColorBrewer")

palette <- brewer.pal(n = 12, name = 'Paired')


## number of species to respresent
nb_species <- length(species)

annotation_colors = list(
  assigned_species = palette[1:nb_species])

## assign names to the list of colors

names(annotation_colors$assigned_species) <- levels(factor(mags_tax$assigned_species))

```


## Plotting cazy enzymes

```{r,message=F,warning=F, fig.height=9, fig.width = 9}

pheat <- pheatmap(heat_ko, cutree_rows = 9,show_rownames = FALSE,
                   show_colnames = FALSE,
                   annotation_row = mags_tax %>%
                      select(disease, westernized, BMI, age_category, assigned_species),
         annotation_colors = annotation_colors,
         main= "COUCOU"
         )

pheat


```


## Plotting one MAGS per species

```{r,message=F,warning=F, fig.height=9, fig.width = 9}

## KO annotations : plot a mags per species

for (one_species in species){
   
   mags_tax_filtered <- mags_tax %>% filter(assigned_species == one_species)
   
   print(nrow(mags_tax))
   
   pheat <- pheatmap(heat_ko %>% filter(row.names(.) %in% rownames(mags_tax_filtered)),
                     cutree_rows = 9,
                     show_rownames = FALSE,
                     show_colnames = FALSE,
                     annotation_row = mags_tax_filtered %>%
                        select(disease, westernized, BMI, age_category),
                     annotation_colors = annotation_colors,
                     main= paste0(one_species, " MAGS")
                     )

   pheat
}

```