---
title: "DMM_clustering"
author: "ruben"
date: "30/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## LIbrairies

```{r,message=F,warning=F}

library(data.table)
library(devtools)
library(microbiome)
library(DirichletMultinomial)
library(reshape2)
library(magrittr)
library(phyloseq)
library(dplyr)
library(tibble)
library(ggplot2)

library(gplots)

source(file = "functions.R")

```

## Data

```{r,message=F,warning=F}

number = 12000

set.seed(number)

threshold = 500

# we load this file to have taxa table specifically
load(file = "study_after_QC.rda")

# we load only the phy object
load(file = "phy_curated_data_after_QC.rda")

phy <- subset_samples(phy, body_site == "stool")

#phy <- subset_samples(phy, age_category == "adult")

#phy <- subset_samples(phy, disease == "Control")

phy <- subset_samples(phy, antibiotics_current_use == "no")

pseq <- subset_taxa(phy, Genus %in% c("Bifidobacterium"))


```



## Transformation

```{r,message=F,warning=F}

# phy.comp <- microbiome::transform(phy, "compositional")
# compositional transformation, ie, relative abundance

#taxa <- core_members(phy.comp, detection = 0.1/100, prevalence = 50/100)

#pseq <- prune_taxa(taxa, phy)

# Pick the OTU count matrix
# and convert it into samples x taxa format
dat <- abundances(pseq)
count_raw <- as.matrix(t(dat))

# rowsums equal zero (sample with 0 count everywhere) need to be deleted

sample_low_reads <- names(which(rowSums(count) <= 500))

# colsums equal zero (bacteria not present in any sample) need to be deleted

count <- count_raw %>%
  as.data.frame(.) %>%
  filter_all(., any_vars(. != 0))

# colsums equal zero (bacteria not present in any sample) need to be deleted

otu_not_present <- names(which(colSums(count) == 0))

count <- count %>%
  select(-otu_not_present) %>%
  ## filtering ppl with nb reads < threshold
  filter(!row.names(.) %in% sample_low_reads) %>%
  as.matrix(.)

# transform colnames to species name

colnames(count) <- get_species(as.data.frame(tax),colnames(count))

```

## Model fit

```{r,message=F,warning=F}


range <- c(1:30)

fit <- mclapply(range, dmn, count = count, verbose=TRUE, mc.cores = 12)

save(fit, file=paste0("DMM_fit_seed_",number))

load(paste0("DMM_fit_seed_",number))
# =======
# if(!("DMM_fit.rda" %in% list.files())) {
#   fit <- lapply(c(1:10,15,20), dmn, count = count, verbose=TRUE);
#   save(fit, file="DMM_fit.rda")
# } else {load("DMM_fit.rda")}
# >>>>>>> d23d0998d606f3ef9435839c4370b19bb1c3394d




```

## Laplace check

```{r,message=F,warning=F}

lplc <- base::sapply(fit, DirichletMultinomial::laplace)

aic  <- base::sapply(fit, DirichletMultinomial::AIC)

bic  <- base::sapply(fit, DirichletMultinomial::BIC)


## pick the optimal model

best <- fit[[which.min(unlist(bic))]]

mixturewt(best)

```

## Laplace figure

```{r,message=F,warning=F}

laplace_plot <- data.frame(Fit = lplc, k = c(1:length(lplc)))
aic_plot <- data.frame(Fit = aic, k = c(1:length(aic)))
bic_plot <-data.frame(Fit = bic, k = c(1:length(bic)))

## on bind les 3 par lignes

binded <- bind_rows(list(laplace = laplace_plot, aic = aic_plot, bic = bic_plot), .id = "type_check")

## the minimum for laplace check

mins_laplace <- binded %>%
  filter(type_check == 'laplace' ) %>%
  filter(Fit == min(Fit)) %>%
  select(Fit, k)

mins_bic <- binded %>%
  filter(type_check == 'bic' ) %>%
  filter(Fit == min(Fit)) %>%
  select(Fit, k)


ggplot(binded) +
  geom_line(aes(x=k, y=Fit, group=type_check, color =type_check)) +
  theme_minimal() +
  scale_x_continuous(breaks = seq(0, max(binded$k) + 5, by = 5))  +
  
  ### we add laplace minimum
  annotate("point", x=mins_laplace$k, y=mins_laplace$Fit, color='orange', size=4) +
  geom_hline(yintercept = mins_laplace$Fit, linetype='dashed') +
  annotate("label", x=max(laplace_plot$k) + 3, y=mins_laplace$Fit, color='black', label= c("laplace minimum"), size=4) +
  annotate(geom = "text", x = mins_laplace$k, y = mins_laplace$Fit, label = paste0("k = ", mins_laplace$k), vjust = -0.5) +
  
    ### we add bic minimum
  annotate("point", x=mins_bic$k, y=mins_bic$Fit, color='orange', size=4) +
  geom_hline(yintercept = mins_bic$Fit, linetype='dashed') +
  annotate("label", x=max(laplace_plot$k) + 3, y=mins_bic$Fit, color='black', label= c("bic minimum"), size=4) +
  annotate(geom = "text", x = mins_bic$k, y = mins_bic$Fit, label = paste0("k = ", mins_bic$k), vjust = -0.5) +
  
  coord_cartesian(xlim =c(min(binded$k),max(binded$k) + 6))  +
  
  labs(x = "Number of Dirichlet Component - K", y = "Model Fit", title = paste0("seed = ", number), color = "")

#max(laplace_plot$k) + 10

```

## Laplace check

```{r,message=F,warning=F}

## sample component assignments

model <- apply(mixture(best), 1, which.max)

## write the enterotype file

enterotype <- data.frame(enterotype = model)

write.csv(enterotype, file="enterotype_DMM", row.names=TRUE, col.names=TRUE, quote=FALSE)

t <- fread("enterotype_DMM") %>%
  column_to_rownames("V1")
```

## Laplace check

```{r,message=F,warning=F}

for (k in seq(ncol(fitted(best)))) {
  d <- melt(fitted(best))
  colnames(d) <- c("OTU", "cluster", "value")
  d <- subset(d, cluster == k) %>%
     # Arrange OTUs by assignment strength
     arrange(value) %>%
     mutate(OTU = factor(OTU, levels = unique(OTU))) %>%
     # Only show the most important drivers
     filter(abs(value) > quantile(abs(value), 0.8))     

  p <- ggplot(d, aes(x = OTU, y = value, fill = OTU)) +
    theme_minimal() +
       geom_bar(stat = "identity") +
       coord_flip() +
       labs(title = paste("Top drivers: community type", k))
  print(p)
}

```

## Heatmaps

```{r,message=F,warning=F,fig.width=15, fig.height=8}

matrix_int <- fitted(best) %>%
  log10(.) %>%
  round(.,2)

matrix_int <- round(matrix_int,2)

## replace col and rownames

colnames(matrix_int) <- paste("cluster ",1:ncol(matrix_int))

rownames(matrix_int) <- gsub("Bifidobacterium","",rownames(matrix_int))


my_palette <- colorRampPalette(c("red", "yellow", "green"))(n = 299)

col_breaks = c(seq(0.81,1,length=100), # for red
seq(0,0.8,length=100),  # for yellow
seq(-1,0,length=100)) # for green

#png(filename = "heatmap_dmm.png", width = 1000, height = 1000, units = "px")

heatmap.2(matrix_int,
  cellnote = matrix_int,  # same data set for cell labels
  main = "", # heat map title
  notecol="black",      # change font color of cell labels to black
  density.info="none",  # turns off density plot inside color legend
  trace="none",         # turns off trace lines inside the heat map
  margins = c(12,9),     # widens margins around plot
  col=my_palette,       # use on color palette defined earlier
  dendrogram="none",     # only draw a row dendrogram
  Colv="NA",
  key.title = "",
  key.xlab = expression(paste("log"[10],"(Value)")))           # turn off column clustering


#dev.off()

```

## Tableaux de contingence

```{r,message=F,warning=F}

enterotype <- t %>%
  rownames_to_column("sample_id")

## on va merge avec map

map <- phy@sam_data %>%
  data.frame(.) %>%
  rownames_to_column("sample_id") %>%
  merge(., enterotype, by="sample_id") %>%
  select(enterotype,westernized,age_category,disease) %>%
  group_by(enterotype,westernized) %>%
  summarise(rows = n()) %>%
    group_by(enterotype) %>%
  mutate(percent = rows/sum(rows)) %>%
  filter(westernized == 'yes')

map$enterotype <- as.character(map$enterotype)


ggplot(map, aes(x = enterotype, y = percent, fill = westernized)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(percent*100,1),"%")), position = position_fill(vjust = 0.5), size =3) +
  theme_classic() +
  labs(x = "Cluster K", y = "amount")

```

## Description des clusters

```{r,message=F,warning=F}

distribution <- function(category){
  

  map <- phy@sam_data %>%
    data.frame(.) %>%
    rownames_to_column("sample_id") %>%
    merge(., enterotype, by="sample_id") %>%
    select(enterotype,westernized,age_category,disease) %>%
    group_by_at(enterotype,westernized) %>%
    summarise(rows = n()) %>%
    group_by(enterotype) %>%
    mutate(percent = rows/sum(rows)) %>%
    filter(westernized == 'yes')

  map$enterotype <- as.character(map$enterotype)


  ggplot(map, aes(x = enterotype, y = percent, fill = westernized)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = paste0(round(percent*100,1),"%")), position = position_fill(vjust = 0.5)) +
    theme_classic() +
    labs(x = "Cluster K", y = "amount")

}

```

## Conseils

```{r,message=F,warning=F}

## heatmap avec les 15 clusters en x et en y : bifids, valeur 

## prévalence des metadata () : table de contingence entre les clysters et maladies western/non western : voir si des clusters sont plus enrichis en individus sains, adultes etc etc

## alpha diversité : package vegan : fonction pour calculer l'alpha diversité, diversité Shannon, sans filre sur les abondances, et après croiser avec la table des bifids (lequel est le plus riche en alpha diversité)
## récupérer ceux qui ont des sample 0, et les mettre dans un cluster à part (cluster 16 no bifids), et pareil les confronter avc les metadata

# dans le réseau, extraire le poids des liens, positifs ou négatifs

#sebeta <- symBeta(getOptBeta(MSP_spiec_easi), mode='maxabs')

## récuprer les beta les poids du réseau à partir de l'objet MSP_spiec_easi

# tableau adjacent

# https://mibwurrepo.github.io/Microbial-bioinformatics-introductory-course-Material-2018/inference-of-microbial-ecological-networks.html




### faire un tableau du nombre de k meilleur en fonction des seeds




# 1 faire le script pour lancer la nuit

# tableau de contingence age, diversité, avec Shannon, westernized/non westernized, croiser avec les enterotypes (qui a été fait sur tous les genre grâce à DMM)

# figure de Muriel

```



