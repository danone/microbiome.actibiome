---
title: "DMM_clustering"
author: "ruben"
date: "30/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Librairies

```{r,message=F,warning=F}

library(data.table)
library(devtools)
library(microbiome)
library(DirichletMultinomial)
library(reshape2)
library(magrittr)
library(phyloseq)
library(dplyr)
library(tibble)
library(rstatix)
library(ggpubr)
library(ggplot2)
library(tidyverse)
library("readxl")
library("optparse")
library(varhandle)
library(tidyr)
library("stringr")

library(gplots)

source(file = "functions.R")

setwd("/home/ladeirru/GitHub/microbiome.actibiome")

```


## Data

```{r,message=F,warning=F}

seed = 12000

set.seed(seed)

threshold = 500

# we load this file to have taxa table specifically
load(file = "study_after_QC.rda")

# we load only the phy object
load(file = "phy_curated_data_after_QC.rda")

phy <- subset_samples(phy, body_site == "stool")

## diversity vegan

phy_diversity <- estimate_richness(phy, split = TRUE, measures = "Shannon")

#phy <- subset_samples(phy, age_category == "adult")

#phy <- subset_samples(phy, disease == "Control")

phy <- subset_samples(phy, antibiotics_current_use == "no")

```

## Filtering curated/ascinar data

```{r,message=F,warning=F}

pseq <- subset_taxa(phy, Genus %in% c("Bifidobacterium"))


which_study <- readline(prompt=paste("Do you want to cluster the data on ASNICAR (Predict) or whole CURATED data without predict ? : ", "pre - PREDICT", "cur - CURATED","", sep="\n"))

while(!which_study %in% c("cur", "pre")){
  which_study <- readline(prompt=paste("Error, please redo : ", "pre - PREDICT", "cur -
                                       CURATED","", sep="\n"))
}

if(which_study == "cur"){
  ## we exclude predict data
  
  pseq <- subset_samples(pseq, !PMID == 33432175)
  
} else{
  ## we keep only predict data
  
  pseq <- subset_samples(pseq, PMID == 33432175)
  
}
```

## File names

```{r,message=F,warning=F}

## file names for saving seeds and DMM results

dmm_name = paste0("DMM_", which_study)

seeds_list_name = paste0("seeds_", which_study)

```

## Transformation

```{r,message=F,warning=F}

# phy.comp <- microbiome::transform(phy, "compositional")
# compositional transformation, ie, relative abundance

#taxa <- core_members(phy.comp, detection = 0.1/100, prevalence = 50/100)

#pseq <- prune_taxa(taxa, phy)

# Pick the OTU count matrix
# and convert it into samples x taxa format
dat <- abundances(pseq)
count_raw <- as.matrix(t(dat))

# rowsums equal zero (sample with 0 count everywhere) need to be deleted

sample_low_reads <- names(which(rowSums(count_raw) <= 500))

# colsums equal zero (bacteria not present in any sample) need to be deleted

count <- count_raw %>%
  as.data.frame(.) %>%
  filter_all(., any_vars(. != 0))

## select ppl with 0 bifid, they are selected as a no bifid cluster

no_bifid <- count_raw %>%
  as.data.frame(.) %>%
  filter(!row.names(.) %in% rownames(count))

# colsums equal zero (bacteria not present in any sample) need to be deleted

otu_not_present <- names(which(colSums(count) == 0))

count <- count %>%
  select(-otu_not_present) %>%
  ## filtering ppl with nb reads < threshold
  filter(!row.names(.) %in% sample_low_reads) %>%
  as.matrix(.)

# transform colnames to species name

colnames(count) <- get_species(as.data.frame(tax),colnames(count))

```


## Code à faire marcher la nuit

```{r,message=F,warning=F}

fit_genus_list = vector("list",5)


set.seed(seed)
seeds=sample(1:1000, 5)

setwd("/home/ladeirru/GitHub/microbiome.actibiome")

if(!(dmm_name %in% list.files()) & !(seeds_list_name %in% list.files())) {

  for(i in 1:5) {

    set.seed(seeds[i])

    fit_genus <- mclapply(1:30, dmn, count=count, verbose=FALSE, mc.cores=12)

    fit_genus_list[[i]] = fit_genus
    
    print(i)

  }
  
  save(fit_genus_list, file=paste0("./DMM_files/", dmm_name))
  
  save(seeds, file = paste0("./DMM_files/", seeds_list_name))

} else {
  load(name)
  load("seeds_list")
  }

# collect scores to find the best fit
lplc = vector("list",5)
bic <- vector("list",5)
aic <- vector("list",5)

for(i in 1:5) {

  
  lplc[[i]] <- base::sapply(fit_genus_list[[i]], DirichletMultinomial::laplace)

  aic[[i]]  <- base::sapply(fit_genus_list[[i]], DirichletMultinomial::AIC)

  bic[[i]]  <- base::sapply(fit_genus_list[[i]], DirichletMultinomial::BIC)

}

```
## Model fit

```{r,message=F,warning=F}

## we will take the number k for each model and for each method

list_k <- vector("list",15)

for (i in 1:5) {
  
  seed_experiment <-seeds[[i]]
  
  list_k[[i]] <- c("lplc", rank(lplc[[i]]), seed_experiment)
  
  list_k[[i+5]] <- c("aic", rank(aic[[i]]), seed_experiment)
  
  list_k[[i+10]] <- c("bic", rank(bic[[i]]), seed_experiment)
  
  print(i)
  
}

test <- data.frame(t(as.data.frame(list_k)))

rownames(test) <- NULL

colnames(test) <- c("method", 1:30, "seed")


test_unfactored <- test %>%
  select('1':'30') %>%
  varhandle::unfactor(.) %>%
  cbind(method = test$method, . , seed = test$seed)
rownames(test_unfactored) <- NULL
  

## calcul des rangs moyens

mean_rank <- test_unfactored %>%
  select(-seed) %>%
  group_by(method) %>%
  summarise_all(mean) %>%
  gather(., key="k", value="mean_rank", '1':'30')

```


## Plot des rangs moyens

```{r,message=F,warning=F}

ggplot(mean_rank) +
  geom_line(aes(x=k, y=mean_rank, group=method, color =method)) +
  theme_minimal() +
  scale_x_discrete(limits = as.character(1:30))

```
## Model selection

```{r,message=F,warning=F}

## k to select is the minimum for BIC

k_BIC <- mean_rank %>%
  filter(method == "bic") %>%
  filter(mean_rank == min(.$mean_rank)) %>%
  select(k) %>%
  as.numeric(.)

## we select k=6 with BIC method

model_k <- vector("list",5)

for (i in 1:5) {
  model_k[[i]] <- which(bic[[i]] == min(bic[[i]]))
}

index <- which(abs(as.data.frame(model_k) - 6) == min(abs(as.data.frame(model_k) - 6)) )

## the model 1 is the best fit model


if (length(index) > 0){
  ## if several models has a min corresponding to the mean rank
  ## choose a random model
  
  index <- sample(index, 1)
  
  }

fit <- fit_genus_list[[index]]

best <- fit[[which.min(unlist(bic[[index]]))]]

## best is the best model based on BIC criteria

pi_theta <- data.frame(mixturewt(best)) %>%
  rownames_to_column("cluster") %>%
  gather(key='method', value='value',pi:theta)

pi_theta$cluster <- as.character(pi_theta$cluster)

```

## teta comparison

# calculate a model k = 1

```{r,message=F,warning=F}

set.seed(seeds)

fit_genus_k1 <- mclapply(1:1, dmn, count=count, verbose=FALSE, mc.cores=12)

```

# plot

```{r,message=F,warning=F}

## we plot pi and theta by clusters. theta : give the idea of the homogeneity of each cluster

ggplot(pi_theta) +
  geom_line(aes(x=cluster, y=value, group=method, color =method)) +
  theme_minimal() +
  scale_x_discrete(limits = as.character(1:6)) +
  labs(color="", y = "")

```


## Check figure

```{r,message=F,warning=F}

laplace_plot <- data.frame(Fit = lplc[[index]], k = c(1:length(lplc[[index]])))
aic_plot <- data.frame(Fit = aic[[index]], k = c(1:length(aic[[index]])))
bic_plot <-data.frame(Fit = bic[[index]], k = c(1:length(bic[[index]])))

## on bind les 3 par lignes

binded <- bind_rows(list(laplace = laplace_plot, aic = aic_plot, bic = bic_plot), .id = "type_check")

## the minimum for laplace check

mins_laplace <- binded %>%
  filter(type_check == 'laplace' ) %>%
  filter(Fit == min(Fit)) %>%
  select(Fit, k)

mins_bic <- binded %>%
  filter(type_check == 'bic' ) %>%
  filter(Fit == min(Fit)) %>%
  select(Fit, k)


ggplot(binded) +
  geom_line(aes(x=k, y=Fit, group=type_check, color =type_check)) +
  theme_minimal() +
  scale_x_continuous(breaks = seq(0, max(binded$k) + 5, by = 5))  +
  
  ### we add laplace minimum
  annotate("point", x=mins_laplace$k, y=mins_laplace$Fit, color='orange', size=4) +
  geom_hline(yintercept = mins_laplace$Fit, linetype='dashed') +
  annotate("label", x=max(laplace_plot$k) + 3, y=mins_laplace$Fit, color='black', label= c("laplace minimum"), size=4) +
  annotate(geom = "text", x = mins_laplace$k, y = mins_laplace$Fit, label = paste0("k = ", mins_laplace$k), vjust = -0.5) +
  
    ### we add bic minimum
  annotate("point", x=mins_bic$k, y=mins_bic$Fit, color='orange', size=4) +
  geom_hline(yintercept = mins_bic$Fit, linetype='dashed') +
  annotate("label", x=max(laplace_plot$k) + 3, y=mins_bic$Fit, color='black', label= c("bic minimum"), size=4) +
  annotate(geom = "text", x = mins_bic$k, y = mins_bic$Fit, label = paste0("k = ", mins_bic$k), vjust = -0.5) +
  
  coord_cartesian(xlim =c(min(binded$k),max(binded$k) + 6))  +
  
  labs(x = "Number of Dirichlet Component - K", y = "Model Fit", title = "", color = "")

```

## Laplace check

```{r,message=F,warning=F}

## sample component assignments

model <- apply(mixture(best), 1, which.max)

## write the enterotype file

enterotype <- data.frame(bifidotype = model)

enterotype <- enterotype %>%
  rownames_to_column("sample_id")

## add no bifid cluster as cluster 7 to enterotype

no_bifid_ <- no_bifid %>%
  rownames_to_column("sample_id") %>%
  select(sample_id) %>%
  mutate(bifidotype = rep(max(enterotype$bifidotype) +1,nrow(.)))

# rbind no bifid to enterotype
enterotype <- enterotype %>%
  rbind(., no_bifid_)

write.csv(enterotype, file="enterotype_DMM_withnobifid", row.names=TRUE, col.names=TRUE, quote=FALSE)

t <- fread("enterotype_DMM") %>%
  column_to_rownames("V1")

enterotype$bifidotype <- as.character(enterotype$bifidotype)

```

## filtering after clustering

```{r,message=F,warning=F}

## predict = asnicar 2021

## we remove other age categories, we only keep adults

adults <- phy@sam_data %>%
  data.frame(.) %>%
  filter(age_category == "adult") %>%
  rownames_to_column("sample_id") %>%
  select(sample_id)

asnicar <- phy@sam_data %>%
  data.frame(.) %>%
#  filter(PMID == 33432175) %>%
  rownames_to_column("sample_id") %>%
  select(sample_id)

bifidotype <- enterotype %>%
  filter(sample_id %in% adults$sample_id) #%>% filter(sample_id %in% asnicar$sample_id)



```

## Clusters distributions

```{r,message=F,warning=F}

distribution <- enterotype %>%
  select(-sample_id) %>%
  group_by(bifidotype) %>%
  table(.) %>%
  data.frame(.)

distribution$. <- as.character(distribution$.)

ggplot(distribution, aes(x = ., y = Freq, fill = .)) +  # Plot with values on top
  geom_bar(stat = "identity") +
  geom_text(aes(label = Freq), vjust = 0) +
  labs( y = "count")

```

## Bifido relative abundance per cluster

```{r,message=F,warning=F,fig.width=15, fig.height=8}

phy_relative <- phy %>%
  prune_samples(sample_names(.) %in% enterotype$sample_id, .) %>%
  microbiome::transform(., "compositional")

tax <- data.frame(phy_relative@tax_table)

otu <- data.frame(phy_relative@otu_table)

```


## Heatmaps

```{r,message=F,warning=F,fig.width=15, fig.height=8}

matrix_int <- fitted(best) %>%
  log10(.) %>%
  round(.,2)

matrix_int <- round(matrix_int,2)

## replace col and rownames

colnames(matrix_int) <- paste("cluster ",1:ncol(matrix_int))

rownames(matrix_int) <- gsub("Bifidobacterium","B. ",rownames(matrix_int))


my_palette <- colorRampPalette(c("red", "yellow", "green"))(n = 299)

col_breaks = c(seq(0.81,1,length=100), # for red
seq(0,0.8,length=100),  # for yellow
seq(-1,0,length=100)) # for green

#png(filename = "heatmap_dmm.png", width = 1000, height = 1000, units = "px")

heatmap.2(matrix_int,
  cellnote = matrix_int,  # same data set for cell labels
  main = "", # heat map title
  notecol="black",      # change font color of cell labels to black
  density.info="none",  # turns off density plot inside color legend
  trace="none",         # turns off trace lines inside the heat map
  margins = c(12,9),     # widens margins around plot
  col=my_palette,       # use on color palette defined earlier
  dendrogram="none",     # only draw a row dendrogram
  Colv="NA",
  key.title = "",
  key.xlab = expression(paste("log"[10],"(Value)")))           # turn off column clustering


#dev.off()

```
## Bifido relative abundance per cluster

```{r,message=F,warning=F}

## select only bifid species and do sum of all bifid species abundances

bifido_names <- tax %>%
  filter(Genus == "Bifidobacterium") %>%
  rownames(.)

otu_bifid <- otu %>%
  filter(row.names(.) %in% bifido_names) %>%
  colSums(.) %>%
  data.frame(bif_rel = .) %>%
  rownames_to_column("sample_id")

sam_data <- phy_relative@sam_data %>%
  data.frame(.) %>%
  rownames_to_column("sample_id") %>%
  left_join(., otu_bifid, by="sample_id") %>%
  ## merge with cluster
  left_join(., enterotype, by="sample_id")
  

```

## Bifido five most abundant species per cluster

```{r,message=F,warning=F}

colnames(matrix_int) <- 1:(as.numeric(max(enterotype$bifidotype)) -1)

top_5 <- matrix_int %>%
  data.frame(.)
colnames(top_5) <- c( 1:(as.numeric(max(enterotype$bifidotype)) -1))

top_5 <- top_5 %>%
  rownames_to_column('species') %>%
  gather(key="cluster", value="value", 2:(ncol(matrix_int)+1)) %>%
  group_by(cluster) %>%
  top_n(5, value) %>%
  select(-value) %>%
  rename('bifidotype' = 'cluster')
top_5$species = gsub("B.", "Bifidobacterium", top_5$species)
top_5$bifidotype = gsub("cluster", "", top_5$bifidotype)
## remove multiple spaces
top_5$species <- str_squish(top_5$species)

```

## search for the mean abundance of each species by cluster

```{r,message=F,warning=F}

otu_most <- otu

rownames(otu_most) <- get_species(tax, rownames(otu_most))

## group by cluster the otu table

otu_most <- otu_most %>%
  t(.) %>%
  data.frame(.) %>%
  select(contains("Bifidobacterium"))
colnames(otu_most) <- gsub("\\.", " ", colnames(otu_most))
## remove multiple spaces
colnames(otu_most) <- str_squish(colnames(otu_most))

# which(is.na(otu_most))

otu_most <- otu_most %>%
  rownames_to_column("sample_id") %>%
  right_join(., bifidotype, by = "sample_id") %>%
  filter(!is.na(bifidotype)) %>%
  gather(key="species", value="abundance", 2:33)
  
top_5_abundance <- top_5 %>%
  left_join(., otu_most, by = c("species", "bifidotype")) %>%
  filter(!is.na(abundance) & bifidotype != 7) %>%
  select(-sample_id)

test <- top_5_abundance %>%
  group_by(bifidotype, species) %>%
  summarise(abundance = sum(abundance))

```

## search for the mean abundance of each species by cluster

```{r,message=F,warning=F}


p <- ggplot(top_5_abundance, aes(x = bifidotype,
                       y = abundance, fill = factor(species))) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  labs(fill= "bifidotype") +
  coord_cartesian(ylim = c(0, 0.25))
  
p

```

## Heatmaps

```{r,message=F,warning=F}


p  <- ggplot(sam_data, aes(x = bifidotype,
                       y = bif_rel, fill=bifidotype))
  
p <- p + geom_boxplot(outlier.shape = NA) +
  
  theme_minimal() +
  
  labs(x = NULL, y = NULL, title = "Relative Abundance of Bifidobacterium",fill= "Cluster") + 
  coord_cartesian(ylim=c(0,0.3)) +
  scale_x_discrete(limits = as.character(1:7)) +
  stat_compare_means(label.y = 0.64, label.x ="3") +
  stat_compare_means(label = "p.signif", method = "wilcox", ref.group = "1", label.y = 0.6) +
  coord_cartesian(ylim = c(0, 0.64))
  

p


```

## Boxplot Shannon

```{r,message=F,warning=F}


diversity <- phy_diversity %>%
  rownames_to_column("sample_id") %>%
  merge(., enterotype, by="sample_id") %>%
  select(-sample_id)

diversity$bifidotype <- as.character(diversity$bifidotype)

p <- ggplot(diversity, aes(x = bifidotype,
                       y = Shannon)) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  stat_compare_means(label.y = 4.5, label.x ="3") +
  stat_compare_means(label = "p.signif", method = "wilcox", ref.group = "1", label.y = 4.1) +
  labs(fill= "bifidotype")
  
p


```

## Description des clusters

```{r,message=F,warning=F, fig.height=9, fig.width = 15}


distribution <- function(category, type){
  

  map <- phy@sam_data %>%
    data.frame(.) %>%
    rownames_to_column("sample_id") %>%
    merge(., enterotype, by="sample_id") %>%
    select(bifidotype,all_of(category)) %>%
    group_by_all(.) %>%
    summarise(rows = n(), .groups = 'drop') %>%
    group_by_at('bifidotype') %>%
    mutate(percent = rows/sum(rows)) %>%
    dplyr::rename(., 'category' = category)
  
  
    p2 <- ggplot(map, aes(x = bifidotype,y=percent, fill = category)) +
    geom_bar(stat="identity", position=position_dodge()) +
    geom_text(aes(label = paste0(rows)),vjust=-2.6, color="black",
            position = position_dodge(0.9), size=3.5) +
      geom_text(aes(label = paste0(round(percent*100,1), "%")),vjust=-0.6, color="black",
            position = position_dodge(0.9), size=3.5) +
    #geom_text(aes(label = paste0(round(percent*100,1),"%"), vjust = 1), position = position_fill(vjust = 0.5), size =3) +
    theme_classic() +
    scale_fill_brewer(type = type) +
    labs(x = "Cluster K", y = "percent", fill = category) +
      guides(y = "none") +
      ylim(0, 1.2)
  
  p2

}

distribution('westernized', 'qual')

```

## Description des clusters

```{r,message=F,warning=F, fig.height=9, fig.width = 19}

distribution('disease', "qual")

```

## table de contingence enterotypes * bifidotypes

```{r,message=F,warning=F}

## library for chi squared test ##

library("gplots")

## enterotypes are specific to bifid, so we'll call it bifidotype, comparing it to enterotypes

contingency <- function(file){
  
  
  bifidotype <- enterotype

  enterotype_whole_microbiota <- fread(file) %>%
    data.frame(.) %>%
    select(2:3)
  
  colnames(enterotype_whole_microbiota) <- c("sample_id","bifidotype")

  contingeny_table <- bifidotype %>%
    merge(., enterotype_whole_microbiota, by="sample_id") %>%
    select(- sample_id)

  names(contingeny_table) <- c('bifidotypes','enterotypes')

  contingeny_table <- contingeny_table %>%
    table(.)

  ## représentation graphique 

  test_chisq <- chisq.test(contingeny_table)

  return(test_chisq)
  
  }


## contingency between current bifidotypes(predict or whole - predict) against enterotypes
test_chisq_enterotypes <- contingency("enterotypes_curated_v3_prediction.csv")

## contingency between current bifidotypes(predict or whole - predict) against whole curated bifidotypes

test_chisq_whole <- contingency("enterotype_DMM")

```

## enterotypes * bifidotypes plot with pearson residuals

```{r,message=F,warning=F, fig.height=10, fig.width = 15}
library(corrplot)

corrplot(test_chisq_enterotypes$residuals, is.cor = FALSE)
mtext("Bifidotypes x Enterotypes", at=5, line=-9, cex=1.5, side= 3)

```

## enterotypes * bifidotypes plot with pearson residuals

```{r,message=F,warning=F, fig.height=17, fig.width = 10}
library(corrplot)

corrplot(test_chisq_whole$residuals, is.cor = FALSE)
mtext("Bifidotypes x Whole Bifidotypes", at=5, line=-7, cex=1.5, side= 3)

```



## test health_healthy

```{r,message=F,warning=F}

library(readxl)

## we select the "control", which are "healthy" in the database :

healthy <- map %>%
  select(sample_id, disease) %>%
  filter(disease == 'Control')

print(paste0('le nombre de healthy dans curation est : ',nrow(healthy)))

healthy_healthy <- read_excel('metadata_healthy_healthy.xlsx') %>%
  data.frame(.) %>%
  rename('sample_id' = Sample_ID) %>%
  merge(., healthy, by='sample_id')
  
print(paste0('le nombre de healthy-healthy dans curation est : ',nrow(healthy_healthy)))

```



