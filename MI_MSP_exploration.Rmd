---
title: "MI MSP exploration"
output: html_notebook
---



```{r,message=F,warning=F}

library(dplyr)

```



```{r,message=F,warning=F}

load("data-raw/MilieuInterieur/MilieuInterieur_df_long.rda")


```

```{r,message=F,warning=F}

df_long %>% head()

```

```{r,message=F,warning=F}

microbiome_resources = "/lustre/workgroups/microbiome_resources/reference/IGC/annotation/"

msp_tax = readr::read_tsv(paste0(microbiome_resources,"1661_msps.gtdb_r95_taxonomy.tsv"))

msp_genes = readr::read_tsv(paste0(microbiome_resources,"msp.tsv"))

msp_genes = 
  msp_genes %>% 
  tidyr::separate(msp_name_module_name, into = c("msp","id","module"), extra = "merge", sep = "_") %>%
  mutate(msp = paste0(msp,"_",id)) %>%
  select(-id)


igc_eggnog = readr::read_tsv("/lustre/workgroups/microbiome_resources/reference/IGC/annotation_raw/eggNOG_v5.0/IGC.eggNOG_v5.0.tsv.gz",
                             skip = 2, col_names = TRUE)


eggnog_diff_healthy = readr::read_csv2("data-raw/association_eggnogs_metadata_grp_healthy.csv") %>% filter(p.value < 0.1) %>%
  filter(prevalence_unhealthy > prevalence_healthy)

head(eggnog_diff_healthy)

```

```{r,message=F,warning=F}

msp_tax %>%
  filter(gtdb_classification %in% grep("bifidum", msp_tax$gtdb_classification, value = TRUE)) %>%
  merge(msp_genes, by.x="msp_name", by.y ="msp") %>% 
  merge(igc_eggnog, by.x="gene_name", by.y="query") %>%
  merge(eggnog_diff_healthy, by.x="eggNOG_OGs", by.y="eggnog") -> msp_healthy_associated_genes
  
# msp_tax %>%
#   filter(gtdb_classification %in% grep("Bifidobacterium", msp_tax$gtdb_classification, value = TRUE))



```

```{r,message=F,warning=F}

head(msp_healthy_associated_genes)

```

```{r,message=F,warning=F}

#fake_sample = data.frame(X1="fake", count=0, sample = df_long %>% pull(sample) %>% unique) # to keep all samples

df_healthy_associated_genes_cast <- df_long %>% 
  filter(X1 %in% msp_healthy_associated_genes$gene_name) %>%
  filter(X1 != "fake")
  #rbind(fake_sample) %>%

head(df_long_filtered)

df_healthy_associated_genes_cast <- df_long_filtered %>%
  reshape2::dcast(X1~sample, value.var = "count", fill=0) %>%
  filter(X1 != "fake")


```

```{r,message=F,warning=F}

head(df_healthy_associated_genes_cast)

write.csv2(df_healthy_associated_genes_cast, "df_healthy_msp.csv", quote = F, col.names = TRUE, row.names = TRUE)

```

```{r,message=F,warning=F}


df_healthy_associated_genes_cast %>%
  tibble::column_to_rownames("X1") %>%
  as.matrix %>%
  heatmap()


```


